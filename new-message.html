<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0a84ff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">
<title>New Message - WebNet</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* {box-sizing:border-box;margin:0;padding:0;}
body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#121212;color:#eee;height:100vh;display:flex;flex-direction:column;}
header {background:#181818;padding:15px;display:flex;align-items:center;gap:15px;border-bottom:1px solid #333;position:sticky;top:0;z-index:100;}
.back-btn {color:#0a84ff;font-size:1.2em;cursor:pointer;background:none;border:none;}
.header-title {flex:1;font-weight:bold;font-size:1.1em;text-align:center;}
.search-container {padding:15px;background:#181818;border-bottom:1px solid #333;}
.search-input {width:100%;padding:12px 15px;border-radius:20px;border:none;background:#2a2a2a;color:#eee;outline:none;}
.search-input:focus {background:#333;border-color:#0a84ff;}
.search-input::placeholder {color:#888;}
.users-list {flex:1;overflow-y:auto;padding:0;}
.user-item {display:flex;align-items:center;padding:12px 15px;border-bottom:1px solid #252525;cursor:pointer;transition:background-color 0.2s;}
.user-item:hover {background-color:#1e1e1e;}
.user-avatar {width:50px;height:50px;border-radius:50%;background:#3247e7;display:flex;align-items:center;justify-content:center;font-size:20px;margin-right:15px;flex-shrink:0;}
.user-info {flex:1;}
.user-name {font-weight:bold;font-size:16px;margin-bottom:3px;display:flex;align-items:center;gap:5px;}
.user-username {font-size:14px;color:#888;}
.user-status {width:10px;height:10px;border-radius:50%;background:#444;margin-left:10px;}
.user-status.online {background:#00ff00;} /* Green dot for online users */
.empty-state {display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;text-align:center;padding:20px;color:#888;}
.empty-state i {font-size:60px;margin-bottom:15px;color:#444;}
.empty-state h2 {font-size:20px;margin:0 0 10px 0;color:#eee;}
.empty-state p {font-size:14px;line-height:1.5;max-width:300px;}
.loading {text-align:center;padding:40px 20px;color:#888;font-style:italic;}
.loading i {margin-right:8px;color:#0a84ff;}
nav {display:flex;justify-content:space-around;background:#121212;padding:12px 0;position:fixed;bottom:0;width:100%;border-top:1px solid #333;z-index:100;}
nav a {color:#eee;font-size:20px;text-decoration:none;padding:5px 15px;border-radius:8px;transition:background-color 0.2s;}
nav a:hover, nav a.active {color:#0a84ff;background:#1e1e1e;}
.verified-badge {color:#0a84ff;font-size:0.9em;}
</style>
</head>
<body>

<header>
  <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
  <div class="header-title">New Message</div>
</header>

<div class="search-container">
  <input type="text" class="search-input" id="searchInput" placeholder="Search followed users...">
</div>

<main id="usersList">
  <div class="loading"><i class="fas fa-circle-notch fa-spin"></i> Loading followed users...</div>
</main>

<nav>
  <a href="home.html" class="active"><i class="fas fa-comment"></i></a>
  <a href="search.html"><i class="fas fa-search"></i></a>
  <a href="profile.html"><i class="fas fa-user"></i></a>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA6lvIUQ36aLbjomZnUqsIkkDgv017tcqI",
  authDomain: "webnet2.firebaseapp.com",
  databaseURL: "https://webnet2-default-rtdb.firebaseio.com",
  projectId: "webnet2",
  storageBucket: "webnet2.appspot.com",
  messagingSenderId: "323870835138",
  appId: "1:323870835138:web:bca571d5620b766651565b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let followedUsers = [];

// Back button
window.goBack = () => window.history.back();

// Create user item with verification and online status
function createUserItem(userData, userId) {
  const userItem = document.createElement('div');
  userItem.className = 'user-item';

  const userName = userData.username || userData.email?.split('@')[0] || 'Unknown';
  const userInitial = userName.charAt(0).toUpperCase();

  userItem.innerHTML = `
    <div class="user-avatar">${userInitial}</div>
    <div class="user-info">
      <div class="user-name">${userName}${userData.verified ? ' <i class="fas fa-circle-check verified-badge"></i>' : ''}</div>
      <div class="user-username">${userData.email || 'No email'}</div>
    </div>
    <div class="user-status ${userData.status ? 'online' : ''}"></div>
  `;

  userItem.addEventListener('click', () => {
    startConversation(userId, userName);
  });

  return userItem;
}

// Start conversation
function startConversation(userId, userName) {
  window.location.href = `convo.html?userId=${userId}`;
}

// Filter users based on search
function filterUsers(searchTerm) {
  const filteredUsers = followedUsers.filter(user => {
    const name = user.data.username || user.data.email?.split('@')[0] || '';
    const email = user.data.email || '';
    return name.toLowerCase().includes(searchTerm.toLowerCase()) ||
           email.toLowerCase().includes(searchTerm.toLowerCase());
  });
  displayUsers(filteredUsers);
}

// Display users
function displayUsers(users) {
  const usersList = document.getElementById('usersList');

  if (users.length === 0) {
    usersList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-user-plus"></i>
        <h2>No followed users found</h2>
        <p>Follow some users first to start conversations with them</p>
      </div>
    `;
    return;
  }

  usersList.innerHTML = '';
  users.forEach(user => {
    const userItem = createUserItem(user.data, user.id);
    usersList.appendChild(userItem);
  });
}

// Load followed users in real-time
async function loadFollowedUsersRealtime() {
  if (!currentUser) return;
  const followingRef = ref(db, `users/${currentUser.uid}/following`);
  onValue(followingRef, async (snapshot) => {
    usersList.innerHTML = '<div class="loading"><i class="fas fa-circle-notch fa-spin"></i> Loading followed users...</div>';
    
    if (!snapshot.exists()) {
      displayUsers([]);
      return;
    }

    followedUsers = [];
    const followingIds = Object.keys(snapshot.val());

    for (const userId of followingIds) {
      const userRef = ref(db, `users/${userId}`);
      const userSnapshot = await get(userRef);
      if (userSnapshot.exists()) {
        followedUsers.push({ id: userId, data: userSnapshot.val() });
      }
    }

    // Listen for real-time status updates for each followed user
    followedUsers.forEach(user => {
      const statusRef = ref(db, `users/${user.id}/status`);
      onValue(statusRef, (statusSnapshot) => {
        const status = statusSnapshot.val() || false;
        console.log(`User ${user.id} status updated: ${status ? 'online' : 'offline'}`); // Debug log
        user.data.status = status;
        const searchTerm = document.getElementById('searchInput').value.trim();
        if (searchTerm) filterUsers(searchTerm);
        else displayUsers(followedUsers);
      });
    });

    // Initial display
    const searchTerm = document.getElementById('searchInput').value.trim();
    if (searchTerm) filterUsers(searchTerm);
    else displayUsers(followedUsers);
  });
}

// Auth check
onAuthStateChanged(auth, (user) => {
  if (!user) { window.location.href = "index.html"; return; }
  currentUser = user;
  loadFollowedUsersRealtime();
});

// Search input
document.getElementById('searchInput').addEventListener('input', e => {
  filterUsers(e.target.value.trim());
});
</script>
</body>
</html>