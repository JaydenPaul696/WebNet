<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <title>WebNet - Profile</title>
  <style>
    body {
      background: #121212;
      color: #eee;
      font-family: system-ui, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #181818;
      border-bottom: 1px solid #333;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      font-weight: bold;
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-left i { cursor: pointer; }

    .settings-btn {
      background: none;
      border: none;
      color: #eee;
      font-size: 16px;
      cursor: pointer;
    }

    /* Loader */
    #loaderOverlay {
      position: absolute;
      inset: 0;
      background: #121212;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 5; /* stays under header/nav */
    }
    .loader {
      border: 5px solid #333;
      border-top: 5px solid #0a84ff;
      border-radius: 50%;
      width: 55px;
      height: 55px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Profile content */
    .profile-container {
      position: relative;
      flex: 1;
      padding: 20px;
      text-align: center;
    }
    .avatar-placeholder {
      font-size: 80px;
      color: #666;
      margin-bottom: 10px;
    }
    .user-info h2 {
      font-size: 20px;
      margin: 5px 0;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .user-info p {
      margin: 4px 0;
      color: #aaa;
      font-size: 14px;
    }
    .bio {
      margin-top: 10px;
      font-style: italic;
      color: #999;
      font-size: 14px;
    }

    .counts {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 12px;
      font-size: 14px;
      color: #bbb;
    }

    /* Buttons */
    .follow-btn,
    .logout-btn {
      display: block;
      margin: 15px auto;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      background: #0a84ff;
      color: #fff;
    }
    .follow-btn.following { background: #444; color: #eee; }
    .logout-btn { background: #333; }

    /* Bottom navbar */
    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #181818;
      border-top: 1px solid #333;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 10;
    }
    nav a {
      color: #eee;
      font-size: 20px;
      text-decoration: none;
    }
    nav a.active,
    nav a:hover {
      color: #0a84ff;
    }

    /* Verified */
    .verified-icon {
      color: #0a84ff;
      font-size: 0.9em;
    }

    /* FAB */
    .fab {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background: #0a84ff;
      color: #fff;
      font-size: 24px;
      padding: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 15;
    }
    .fab:hover { background: #006ad4; }
  a {
    text-decoration: none;
    color: white;
  }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <i id="backBtn" class="fas fa-arrow-left" style="display:none;"></i>
    <span id="headerTitle">My Profile</span>
  </div>
  <button class="settings-btn" id="settingsBtn"><a href="settings.html"><i class="fas fa-cog"></i></a></button>
</header>

<div class="profile-container" id="profileContainer">
  <div id="loaderOverlay">
    <div class="loader"></div>
    <p style="margin-top:15px;color:#bbb;">Loading profile...</p>
  </div>

  <div class="avatar-placeholder"><i class="fas fa-user-circle"></i></div>
  <div class="user-info">
    <h2 id="realName">Loading...</h2>
    <p id="username">@username</p>
    <p id="userEmail">email</p>
    <p id="userBio" class="bio">No bio set yet.</p>
    <div class="counts">
      <span id="followersCount">0</span> Followers
      <span id="followingCount">0</span> Following
    </div>
  </div>
  <button id="followBtn" class="follow-btn" style="display:none;">Follow</button>
  <button id="logoutBtn" class="logout-btn" style="display:none;">Sign out</button>
</div>

<!-- FAB to create new post -->
<a href="post.html" class="fab"><i class="fas fa-earth"></i></a>

<nav>
  <a href="home.html"><i class="fas fa-comment"></i></a>
  <a href="search.html"><i class="fas fa-search"></i></a>
  <a href="notifications.html"><i class="fas fa-bell"></i></a>
  <a href="profile.html" class="active"><i class="fas fa-user"></i></a>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getDatabase, ref, get, onValue, set, remove, push } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA6lvIUQ36aLbjomZnUqsIkkDgv017tcqI",
  authDomain: "webnet2.firebaseapp.com",
  projectId: "webnet2",
  storageBucket: "webnet2.appspot.com",
  messagingSenderId: "323870835138",
  appId: "1:323870835138:web:bca571d5620b766651565b",
  databaseURL: "https://webnet2-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const loaderOverlay = document.getElementById("loaderOverlay");
const realNameElem = document.getElementById("realName");
const usernameElem = document.getElementById("username");
const emailElem = document.getElementById("userEmail");
const bioElem = document.getElementById("userBio");
const followersCountElem = document.getElementById("followersCount");
const followingCountElem = document.getElementById("followingCount");
const followBtn = document.getElementById("followBtn");
const logoutBtn = document.getElementById("logoutBtn");
const backBtn = document.getElementById("backBtn");
const headerTitle = document.getElementById("headerTitle");
const settingsBtn = document.getElementById("settingsBtn");

const params = new URLSearchParams(window.location.search);
const profileUidParam = params.get("uid");

onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = "index.html"; return; }

  const myUid = user.uid;
  const uidToLoad = profileUidParam || myUid;

  if (profileUidParam && profileUidParam !== myUid) {
    settingsBtn.style.display = "none";
    backBtn.style.display = "inline";
    backBtn.onclick = () => window.history.back();
    headerTitle.textContent = "User Profile";
    logoutBtn.style.display = "none";
    followBtn.style.display = "inline-block";

    onValue(ref(db, `users/${uidToLoad}/followers/${myUid}`), (snap) => {
      if (snap.exists()) {
        followBtn.textContent = "Following";
        followBtn.classList.add("following");
      } else {
        followBtn.textContent = "Follow";
        followBtn.classList.remove("following");
      }
    });

    followBtn.onclick = async () => {
      const isFollowing = followBtn.classList.contains("following");
      if (isFollowing) {
        await remove(ref(db, `users/${uidToLoad}/followers/${myUid}`));
        await remove(ref(db, `users/${myUid}/following/${uidToLoad}`));
      } else {
        await set(ref(db, `users/${uidToLoad}/followers/${myUid}`), true);
        await set(ref(db, `users/${myUid}/following/${uidToLoad}`), true);

        const mySnap = await get(ref(db, `users/${myUid}`));
        if (mySnap.exists()) {
          const me = mySnap.val();
          const notifRef = ref(db, `users/${uidToLoad}/notifications`);
          const newNotifRef = push(notifRef);
          await set(newNotifRef, {
            type: "follow",
            message: `${me.realName || "Someone"} (@${me.username || "unknown"}) started following you`,
            from: myUid,
            timestamp: Date.now(),
            read: false
          });
        }
      }
    };
  } else {
    settingsBtn.style.display = "inline";
    backBtn.style.display = "none";
    headerTitle.textContent = "My Profile";
    logoutBtn.style.display = "inline-block";
    followBtn.style.display = "none";

    // ðŸ”¹ Fix sign out button
    logoutBtn.onclick = async () => {
      await signOut(auth);
      window.location.href = "index.html";
    };
  }

  try {
    const userSnap = await get(ref(db, `users/${uidToLoad}`));
    if (userSnap.exists()) {
      const data = userSnap.val();
      realNameElem.textContent = data.realName || "No Name";

      if (data.verified) {
        const checkIcon = document.createElement("i");
        checkIcon.className = "fa-solid fa-circle-check verified-icon";
        realNameElem.appendChild(checkIcon);
      }

      usernameElem.textContent = data.username ? `@${data.username}` : "@username";
      emailElem.textContent = data.email || "";
      bioElem.textContent = data.bio || "No bio set yet.";
    }
  } catch (e) {
    console.error("Error loading profile:", e);
  } finally {
    loaderOverlay.style.display = "none";
  }

  onValue(ref(db, `users/${uidToLoad}/followers`), snap => {
    followersCountElem.textContent = snap.exists() ? Object.keys(snap.val()).length : 0;
  });
  onValue(ref(db, `users/${uidToLoad}/following`), snap => {
    followingCountElem.textContent = snap.exists() ? Object.keys(snap.val()).length : 0;
  });
});
</script>

</body>
</html>