<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <title>WebNet - Profile</title>
  <style>
    body { background: #121212; color: white; font-family: Arial, sans-serif; margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
    
    header { 
      padding: 15px; 
      background: #111; 
      color: white; 
      font-size: 1.3em; 
      display: flex; 
      justify-content: space-between;
      align-items: center; 
    }
    .header-left { display: flex; align-items: center; gap: 10px; }
    .settings-btn {
      background: #0a84ff;
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background 0.2s;
    }
    .settings-btn:hover { background: #0066cc; }

    nav { position: fixed; bottom: 0; width: 100%; background: #121212; display: flex; justify-content: space-around; align-items: center; padding: 10px 0; border-top: 1px solid #333; z-index: 10; }
    nav a { color: white; font-size: 1.4em; text-decoration: none; }
    nav a:hover { color: #0a84ff; }

    .profile-container { padding: 20px; text-align: center; color: white; display: none; }
    .avatar-placeholder { font-size: 80px; margin-bottom: 10px; }
    .user-info h2 { margin: 0; font-size: 1.6em; display: inline-flex; align-items: center; gap: 6px; }
    .user-info p { font-size: 1em; color: #ccc; }
    .bio { margin-top: 10px; font-style: italic; color: #bbb; }

    .logout-btn {
      margin: 20px auto 10px;
      display: block;
      padding: 10px 20px;
      background: #3247e7;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 1em;
      cursor: pointer;
      max-width: 200px;
      transition: background 0.3s ease;
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .logout-btn:hover { background: #7684f1; }

    .follow-btn { padding: 8px 20px; font-size: 1em; border: none; border-radius: 6px; cursor: pointer; background-color: #3247e7; color: white; transition: 0.3s; margin-top: 15px; max-width: 200px; }
    .follow-btn.following { background-color: #d3d3d3; color: #333; }

    .plus-btn { position: fixed; bottom: 70px; right: 20px; background: #3f2eff; color: white; width: 55px; height: 55px; border-radius: 50%; font-size: 1.6em; display: none; justify-content: center; align-items: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); cursor: pointer; z-index: 15; text-decoration: none; }
    .plus-btn:hover { background: #e01a4f; }

    #loaderOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: #121212;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loader {
      border: 6px solid #333;
      border-top: 6px solid #0a84ff;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .verified-icon {
      color: #0a84ff;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  
<header id="profileHeader">
  <div class="header-left">
    <span id="backBtn" style="display:none; cursor:pointer;">
      <i class="fas fa-arrow-left"></i>
    </span>
    <span id="headerTitle">My Profile</span>
  </div>
  <a href="settings.html" class="settings-btn">
    <i class="fas fa-cog"></i> Settings
  </a>
</header>

<div id="loaderOverlay">
  <div class="loader"></div>
  <p style="margin-top:15px; color:#bbb;">Loading profile...</p>
</div>

<div class="profile-container" id="profileContainer">
  <div class="avatar-placeholder"><i class="fas fa-user-circle"></i></div>
  <div class="user-info">
    <h2 id="realName">Loading...</h2>
    <h3><span id="username"></span></h3>
    <p id="userEmail">Loading...</p>
    <p id="userBio" class="bio">No bio set yet.</p>
    <div style="margin-top:10px; display:flex; justify-content:center; gap:20px;">
      <span id="followersCount">•</span>Followers
      <span id="followingCount">•</span>Following
    </div>
  </div>
  <button id="followBtn" class="follow-btn" style="display:none;">Follow</button>
</div>

<button onclick="logout()" class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sign out</button>
<div class="auth-buttons">
  <button id="signInBtn" class="auth-btn" style="display: none;">
    <i class="fas fa-sign-in-alt"></i> Sign In
  </button>
  <button id="signOutBtn" class="auth-btn signout" style="display: none;">
    <i class="fas fa-sign-out-alt"></i> Sign Out
  </button>
</div>

<nav>
  <a href="home.html"><i class="fas fa-comment"></i></a>
  <a href="search.html"><i class="fas fa-search"></i></a>
  <a href="notifications.html">
    <i class="fas fa-bell"></i>
    <span class="notification-badge" id="notifBadge" style="display:none;">0</span>
  </a>
  <a href="profile.html"><i class="fas fa-user"></i></a>
</nav>

<a id="plusFab" href="post.html" class="plus-btn"><i class="fas fa-earth"></i></a>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
  import { getDatabase, ref, get, onValue, set, remove, push } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA6lvIUQ36aLbjomZnUqsIkkDgv017tcqI",
    authDomain: "webnet2.firebaseapp.com",
    projectId: "webnet2",
    storageBucket: "webnet2.appspot.com",
    messagingSenderId: "323870835138",
    appId: "1:323870835138:web:bca571d5620b766651565b",
    databaseURL: "https://webnet2-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const loaderOverlay = document.getElementById("loaderOverlay");
  const profileContainer = document.getElementById("profileContainer");

  const realNameElem = document.getElementById("realName");
  const usernameElem = document.getElementById("username");
  const emailElem = document.getElementById("userEmail");
  const bioElem = document.getElementById("userBio");
  const followersCountElem = document.getElementById("followersCount");
  const followingCountElem = document.getElementById("followingCount");
  const followBtn = document.getElementById("followBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const plusFab = document.getElementById("plusFab");
  const backBtn = document.getElementById("backBtn");
  const headerTitle = document.getElementById("headerTitle");
  const settingsBtn = document.querySelector('.settings-btn');

  const params = new URLSearchParams(window.location.search);
  const profileUidParam = params.get("uid");

  onAuthStateChanged(auth, async (user) => {
    if(!user) { window.location.href = "index.html"; return; }

    const myUid = user.uid;
    const uidToLoad = profileUidParam || myUid;

    if(profileUidParam && profileUidParam !== myUid) {
      settingsBtn.style.display = "none";
      backBtn.style.display = "inline";
      backBtn.onclick = () => window.history.back();
      headerTitle.textContent = "User Profile";
      plusFab.style.display = "none";
      logoutBtn.style.display = "none";
      followBtn.style.display = "inline-block";

      onValue(ref(db, `users/${uidToLoad}/followers/${myUid}`), (snap) => {
        if(snap.exists()) {
          followBtn.textContent = "Following";
          followBtn.classList.add("following");
        } else {
          followBtn.textContent = "Follow";
          followBtn.classList.remove("following");
        }
      });

      followBtn.onclick = async () => {
        const isFollowing = followBtn.classList.contains("following");
        if (isFollowing) {
          await remove(ref(db, `users/${uidToLoad}/followers/${myUid}`));
          await remove(ref(db, `users/${myUid}/following/${uidToLoad}`));
        } else {
          await set(ref(db, `users/${uidToLoad}/followers/${myUid}`), true);
          await set(ref(db, `users/${myUid}/following/${uidToLoad}`), true);

          try {
            const mySnap = await get(ref(db, `users/${myUid}`));
            if (mySnap.exists()) {
              const me = mySnap.val();
              const notifRef = ref(db, `users/${uidToLoad}/notifications`);
              const newNotifRef = push(notifRef);
              await set(newNotifRef, {
                type: "follow",
                message: `${me.realName || "Someone"} (@${me.username || "unknown"}) started following you`,
                from: myUid,
                timestamp: Date.now(),
                read: false
              });
            }
          } catch (err) {
            console.error("Error sending follow notification:", err);
          }
        }
      };

    } else {
      settingsBtn.style.display = "flex";
      backBtn.style.display = "none";
      headerTitle.textContent = "My Profile";
      plusFab.style.display = "flex";
      logoutBtn.style.display = "inline-block";
      followBtn.style.display = "none";
    }

    try {
      const userSnap = await get(ref(db, `users/${uidToLoad}`));
      if(userSnap.exists()) {
        const data = userSnap.val();
        realNameElem.textContent = data.realName || "No Name";

        // Verification badge
        if (data.verified) {
          const checkIcon = document.createElement("i");
          checkIcon.className = "fa-solid fa-circle-check verified-icon";
          realNameElem.appendChild(checkIcon);
        }

        usernameElem.textContent = data.username ? `@${data.username}` : "Username";
        emailElem.textContent = data.email || "";
        bioElem.textContent = data.bio || "No bio set yet.";
      }
    } catch(e){ console.error("Error loading profile:", e); }
    finally {
      loaderOverlay.style.display = "none";
      profileContainer.style.display = "block";
    }

    onValue(ref(db, `users/${uidToLoad}/followers`), snap => {
      followersCountElem.textContent = snap.exists() ? Object.keys(snap.val()).length : 0;
    });
    onValue(ref(db, `users/${uidToLoad}/following`), snap => {
      followingCountElem.textContent = snap.exists() ? Object.keys(snap.val()).length : 0;
    });
  });

  window.logout = async function() {
    await signOut(auth);
    window.location.href = "index.html";
  };
</script>

</body>
</html>