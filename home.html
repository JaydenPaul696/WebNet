<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0a84ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <title>Messages - WebNet</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    body {margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#121212;color:#eee;display:flex;flex-direction:column;height:100vh;}
    header{padding:15px;font-size:20px;font-weight:bold;text-align:center;border-bottom:1px solid #333;background:#181818;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center;}
    .header-title{flex:1;text-align:center;}
    .header-actions{display:flex;gap:15px;}
    .header-actions button{background:none;border:none;color:#eee;font-size:18px;cursor:pointer;}
    main{flex:1;overflow-y:auto;padding:0;position:relative;}
    .conversation-list{list-style:none;padding:0;margin:0;}
    .conversation{display:flex;align-items:center;padding:12px 15px;border-bottom:1px solid #252525;cursor:pointer;transition:background-color 0.2s;}
    .conversation:hover{background-color:#1e1e1e;}
    .conversation-avatar{width:50px;height:50px;border-radius:50%;background:#3247e7;display:flex;align-items:center;justify-content:center;font-size:20px;margin-right:15px;flex-shrink:0;}
    .conversation-info{flex:1;min-width:0;}
    .conversation-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
    .conversation-name{font-weight:bold;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:4px;}
    .conversation-time{font-size:12px;color:#888;flex-shrink:0;}
    .conversation-bottom{display:flex;justify-content:space-between;align-items:center;}
    .conversation-preview{font-size:14px;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70%;}
    .conversation-unread{background:#0a84ff;color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;}
    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:70vh;text-align:center;padding:20px;color:#888;}
    .empty-state i{font-size:80px;margin-bottom:20px;color:#444;}
    .empty-state h2{font-size:22px;margin:0 0 10px 0;color:#eee;}
    .empty-state p{font-size:16px;line-height:1.5;max-width:300px;}
    nav{display:flex;justify-content:space-around;background:#121212;padding:12px 0;position:fixed;bottom:0;width:100%;border-top:1px solid #333;z-index:100;}
    nav a{color:#eee;font-size:20px;text-decoration:none;padding:5px 15px;border-radius:8px;transition:background-color 0.2s;}
    nav a:hover, nav a.active{color:#0a84ff;background:#1e1e1e;}
    .fab{position:fixed;bottom:70px;right:20px;background:#0a84ff;color:white;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 12px rgba(10,132,255,0.3);cursor:pointer;z-index:99;text-decoration:none;transition:all 0.3s;}
    .fab:hover{background:#0066cc;transform:translateY(-2px);box-shadow:0 6px 16px rgba(10,132,255,0.4);}
    .loader-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:#121212;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:50;}
    .loader{border:6px solid #333;border-top:6px solid #0a84ff;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .verified-icon{color:#0a84ff;font-size:0.8em;}
  </style>
</head>
<body>
<header>
  <div class="header-title">Messages</div>
  <div class="header-actions"><button><i class="fas fa-ellipsis-vertical"></i></button></div>
</header>

<main id="conversationsList">
  <div class="loader-overlay" id="loaderOverlay">
    <div class="loader"></div>
    <p style="margin-top:15px;color:#bbb;">Loading conversations...</p>
  </div>
</main>

<a href="new-message.html" class="fab"><i class="fas fa-comment"></i></a>

<nav>
  <a href="home.html" class="active"><i class="fas fa-comment"></i></a>
  <a href="search.html"><i class="fas fa-search"></i></a>
  <a href="profile.html"><i class="fas fa-user"></i></a>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getDatabase, ref, onValue, get, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA6lvIUQ36aLbjomZnUqsIkkDgv017tcqI",
  authDomain: "webnet2.firebaseapp.com",
  databaseURL: "https://webnet2-default-rtdb.firebaseio.com",
  projectId: "webnet2",
  storageBucket: "webnet2.appspot.com",
  messagingSenderId: "323870835138",
  appId: "1:323870835138:web:bca571d5620b766651565b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const conversationsList = document.getElementById('conversationsList');
const loaderOverlay = document.getElementById('loaderOverlay');

// Helper to append verified badge
async function appendVerifiedBadge(element, uid) {
  try {
    const snap = await get(ref(db, `users/${uid}/verified`));
    if (snap.exists() && snap.val()) {
      const checkIcon = document.createElement('i');
      checkIcon.className = 'fa-solid fa-circle-check verified-icon';
      element.appendChild(checkIcon);
    }
  } catch (error) {
    console.error("Error checking verified status:", error);
  }
}

function formatTime(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  const now = new Date();
  const diff = now - date;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days < 7) return `${days}d ago`;
  return date.toLocaleDateString();
}

async function getLastMessage(conversationId, currentUserId) {
  try {
    const messagesRef = ref(db, `conversations/${conversationId}/messages`);
    const messagesQuery = query(messagesRef, orderByChild('timestamp'), limitToLast(1));
    const snapshot = await get(messagesRef); // Fetch all messages for unread count
    let lastMessage = 'Start a conversation';
    let lastTimestamp = 0;
    let unreadCount = 0;

    if (snapshot.exists()) {
      // Count unread messages (sent by other user, read: false)
      snapshot.forEach(child => {
        const messageData = child.val();
        if (messageData.senderId !== currentUserId && !messageData.read) {
          unreadCount++;
        }
      });
      console.log(`Conversation ${conversationId}: ${unreadCount} unread messages`); // Debug log

      // Get the last message
      const lastMessageSnapshot = await get(messagesQuery);
      if (lastMessageSnapshot.exists()) {
        lastMessageSnapshot.forEach(child => {
          const messageData = child.val();
          lastMessage = messageData.text;
          lastTimestamp = messageData.timestamp;
        });
      }
    }
    
    return { lastMessage, lastTimestamp, unreadCount };
  } catch (error) {
    console.error("Error fetching last message:", error);
  }
  
  return { lastMessage: 'Start a conversation', lastTimestamp: 0, unreadCount: 0 };
}

async function getUserDisplayName(uid) {
  try {
    const userRef = ref(db, `users/${uid}`);
    const snapshot = await get(userRef);
    if (snapshot.exists()) {
      const userData = snapshot.val();
      return userData.username || userData.email.split('@')[0] || 'Unknown';
    }
  } catch (error) {
    console.error("Error fetching user data:", error);
  }
  return 'Unknown';
}

async function createConversationElement(conversationId, otherUserId, currentUserId) {
  const li = document.createElement('li');
  li.className = 'conversation';
  
  const displayName = await getUserDisplayName(otherUserId);
  const initial = displayName.charAt(0).toUpperCase();

  const avatarDiv = document.createElement('div');
  avatarDiv.className = 'conversation-avatar';
  avatarDiv.textContent = initial;

  const infoDiv = document.createElement('div');
  infoDiv.className = 'conversation-info';

  const topDiv = document.createElement('div');
  topDiv.className = 'conversation-top';

  const nameDiv = document.createElement('div');
  nameDiv.className = 'conversation-name';
  nameDiv.textContent = displayName;
  await appendVerifiedBadge(nameDiv, otherUserId);

  const { lastMessage, lastTimestamp, unreadCount } = await getLastMessage(conversationId, currentUserId);
  
  const timeDiv = document.createElement('div');
  timeDiv.className = 'conversation-time';
  timeDiv.textContent = formatTime(lastTimestamp);

  topDiv.appendChild(nameDiv);
  topDiv.appendChild(timeDiv);

  const bottomDiv = document.createElement('div');
  bottomDiv.className = 'conversation-bottom';

  const previewDiv = document.createElement('div');
  previewDiv.className = 'conversation-preview';
  previewDiv.textContent = lastMessage;

  bottomDiv.appendChild(previewDiv);

  if (unreadCount > 0) {
    const unreadDiv = document.createElement('div');
    unreadDiv.className = 'conversation-unread';
    unreadDiv.textContent = unreadCount;
    bottomDiv.appendChild(unreadDiv);
  }

  infoDiv.appendChild(topDiv);
  infoDiv.appendChild(bottomDiv);
  
  li.appendChild(avatarDiv);
  li.appendChild(infoDiv);

  li.addEventListener('click', () => {
    window.location.href = `convo.html?userId=${otherUserId}`;
  });
  
  return li;
}

async function loadConversations(userId) {
  const conversationsRef = ref(db, 'conversations');
  onValue(conversationsRef, async (snapshot) => {
    loaderOverlay.style.display = 'flex';
    
    if (!snapshot.exists()) {
      conversationsList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-comments"></i>
          <h2>No Messages Yet</h2>
          <p>Tap the <i class="fas fa-comment" style="font-size:20px;"></i> button below to start a conversation</p>
        </div>
      `;
      loaderOverlay.style.display = 'none';
      return;
    }

    const conversations = [];
    const promises = [];
    snapshot.forEach(conversationSnap => {
      const conversationId = conversationSnap.key;
      const userIds = conversationId.split('_');
      
      if (userIds.includes(userId)) {
        const otherUserId = userIds.find(id => id !== userId);
        promises.push(
          getLastMessage(conversationId, userId).then(({ lastTimestamp }) => {
            conversations.push({
              conversationId,
              otherUserId,
              lastTimestamp: lastTimestamp || 0
            });
          })
        );
      }
    });

    await Promise.all(promises);

    if (conversations.length === 0) {
      conversationsList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-comments"></i>
          <h2>No Messages Yet</h2>
          <p>Tap the <i class="fas fa-comment" style="font-size:20px;"></i> button below to start a conversation</p>
        </div>
      `;
      loaderOverlay.style.display = 'none';
      return;
    }

    conversations.sort((a, b) => b.lastTimestamp - a.lastTimestamp);

    const ul = document.createElement('ul');
    ul.className = 'conversation-list';
    
    for (const convo of conversations) {
      const convoElement = await createConversationElement(convo.conversationId, convo.otherUserId, userId);
      ul.appendChild(convoElement);
    }

    conversationsList.innerHTML = '';
    conversationsList.appendChild(ul);
    loaderOverlay.style.display = 'none';
  }, (error) => {
    console.error("Error loading conversations:", error);
    loaderOverlay.style.display = 'none';
    conversationsList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle"></i>
        <h2>Error Loading Conversations</h2>
        <p>Please try again later</p>
      </div>
    `;
  });
}

onAuthStateChanged(auth, user => {
  if (!user) window.location.href = 'index.html';
  else loadConversations(user.uid);
});
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js")
      .then(reg => console.log("Service Worker registered:", reg.scope))
      .catch(err => console.error("SW registration failed:", err));
  });
}
</script>

</body>
</html>