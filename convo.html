<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages - WebNet</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: Arial, sans-serif; background:#121212; color:#eee; height:100vh; display:flex; flex-direction:column; }
    header { background:#181818; padding:15px; display:flex; align-items:center; gap:15px; border-bottom:1px solid #333; position:sticky; top:0; z-index:100; }
    .back-btn { color:#0a84ff; font-size:1.2em; cursor:pointer; background:none; border:none; }
    .header-info { flex:1; }
    .recipient-name { font-weight:bold; font-size:1.1em; display:flex; align-items:center; gap:5px; }
    .recipient-name i { color:#0a84ff; font-size:0.9em; }
    .recipient-status { font-size:0.8em; color:#0a84ff; }
    .header-actions { display:flex; gap:15px; }
    .header-actions button { background:none; border:none; color:#eee; font-size:1.1em; cursor:pointer; }
    .messages-container { flex:1; overflow-y:auto; padding:15px; padding-bottom:90px; display:flex; flex-direction:column; gap:10px; }
    .message { max-width:70%; padding:12px; border-radius:18px; margin-bottom:5px; position:relative; }
    .message.sent { background:#0a84ff; color:white; align-self:flex-end; border-bottom-right-radius:5px; }
    .message.received { background:#2a2a2a; color:#eee; align-self:flex-start; border-bottom-left-radius:5px; }
    .message-time { font-size:0.7em; opacity:0.7; margin-top:5px; text-align:right; }
    .message-input-container { position:fixed; bottom:0; left:0; width:100%; padding:15px; background:#181818; border-top:1px solid #333; display:flex; gap:10px; align-items:center; z-index:100; }
    .message-input { flex:1; padding:12px; border:1px solid #333; border-radius:25px; background:#2a2a2a; color:#eee; outline:none; }
    .message-input:focus { border-color:#0a84ff; }
    .send-btn { background:#0a84ff; color:white; border:none; width:45px; height:45px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .send-btn:disabled { background:#333; cursor:not-allowed; }
    .send-btn:hover:not(:disabled) { background:#0066cc; }
    .typing-indicator { padding:10px; color:#0a84ff; font-style:italic; font-size:0.9em; align-self:flex-start; display:none; }
    .message-date { text-align:center; color:#888; font-size:0.8em; margin:15px 0; padding:5px; }
    a:hover { text-decoration:none; color:red; }
    a { text-decoration:none; color:red; }
  </style>
</head>
<body>

<header>
  <button class="back-btn" onclick="goBack()">
    <i class="fas fa-arrow-left"></i>
  </button>
  <div class="header-info">
    <div class="recipient-name" id="recipientName">Loading...</div>
    <div class="recipient-status" id="recipientStatus">Online</div>
  </div>
  <div class="header-actions">
    <button onclick="callUser()"><i class="fas fa-phone"></i></button>
    <button onclick="videoCall()"><i class="fas fa-video"></i></button>
    <button onclick="showProfile()"><i class="fas fa-info-circle"></i></button>
  </div>
</header>

<div class="messages-container" id="messagesContainer">
  <div class="message-date">Today</div>
  <div class="typing-indicator" id="typingIndicator">Typing...</div>
</div>

<div class="message-input-container">
  <input type="text" class="message-input" id="messageInput" placeholder="Type a message..." maxlength="500">
  <button class="send-btn" id="sendBtn" disabled>
    <i class="fas fa-paper-plane"></i>
  </button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
  import { getDatabase, ref, push, onValue, serverTimestamp, get, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA6lvIUQ36aLbjomZnUqsIkkDgv017tcqI",
    authDomain: "webnet2.firebaseapp.com",
    databaseURL: "https://webnet2-default-rtdb.firebaseio.com",
    projectId: "webnet2",
    storageBucket: "webnet2.appspot.com",
    messagingSenderId: "323870835138",
    appId: "1:323870835138:web:bca571d5620b766651565b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let currentUser = null;
  let recipientUser = null;
  let conversationId = null;

  const urlParams = new URLSearchParams(window.location.search);
  const recipientId = urlParams.get('userId');

  const recipientNameElem = document.getElementById('recipientName');
  const recipientStatusElem = document.getElementById('recipientStatus');
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const typingIndicator = document.getElementById('typingIndicator');

  window.goBack = () => window.history.back();
  window.callUser = () => alert('Voice call feature coming soon!');
  window.videoCall = () => alert('Video call feature coming soon!');
  window.showProfile = () => { if(recipientUser) window.location.href=`profile.html?userId=${recipientUser.uid}`; }

  messageInput.addEventListener('input', () => {
    sendBtn.disabled = messageInput.value.trim() === '';
    if(currentUser && conversationId) {
      update(ref(db, `users/${currentUser.uid}/typing`), { [conversationId]: messageInput.value.trim() !== '' });
    }
  });

  messageInput.addEventListener('keypress', (e) => {
    if(e.key === 'Enter' && !sendBtn.disabled) sendMessage();
  });

  async function sendMessage() {
    const messageText = messageInput.value.trim();
    if(!messageText || !conversationId) return;
    sendBtn.disabled = true;
    try {
      await push(ref(db, `conversations/${conversationId}/messages`), {
        senderId: currentUser.uid,
        text: messageText,
        timestamp: serverTimestamp(),
        read: false
      });
      messageInput.value = '';
      sendBtn.disabled = true;
      await update(ref(db, `users/${currentUser.uid}/typing`), { [conversationId]: false });
    } catch(err) {
      console.error("Error sending message:", err);
      sendBtn.disabled = false;
    }
  }

  function formatMessageTime(ts) {
    if(!ts) return '';
    return new Date(ts).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
  }

  function showMessage(message) {
    const isSent = message.senderId === currentUser.uid;
    const msgElem = document.createElement('div');
    msgElem.className = `message ${isSent?'sent':'received'}`;
    msgElem.innerHTML = `<div class="message-text">${message.text}</div><div class="message-time">${formatMessageTime(message.timestamp)}</div>`;
    messagesContainer.appendChild(msgElem);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  async function markMessagesAsRead(conversationId, currentUserId) {
    try {
      const messagesRef = ref(db, `conversations/${conversationId}/messages`);
      const snapshot = await get(messagesRef);
      if (snapshot.exists()) {
        const updates = {};
        snapshot.forEach(child => {
          const message = child.val();
          if (message.senderId !== currentUserId && !message.read) {
            updates[`${child.key}/read`] = true;
            console.log(`Marking message ${child.key} as read`);
          }
        });
        if (Object.keys(updates).length > 0) {
          await update(ref(db, `conversations/${conversationId}/messages`), updates);
          console.log(`Updated ${Object.keys(updates).length} messages to read`);
        }
      }
    } catch (error) {
      console.error("Error marking messages as read:", error);
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if(!user){ window.location.href="index.html"; return; }
    currentUser = user;
    if(!recipientId){ messagesContainer.innerHTML = '<div class="message-date">No user selected</div>'; return; }

    conversationId = [currentUser.uid, recipientId].sort().join('_');

    const recipientRef = ref(db, `users/${recipientId}`);
    const recipientSnapshot = await get(recipientRef);

    if(recipientSnapshot.exists()) {
      const data = recipientSnapshot.val();
      recipientUser = { uid: recipientId, ...data };
      recipientNameElem.textContent = data.username || data.email.split('@')[0];
      if(data.verified) recipientNameElem.innerHTML += ' <i class="fas fa-circle-check"></i>';

      const statusRef = ref(db, `users/${recipientId}/status`);
      onValue(statusRef, snap => { recipientStatusElem.textContent = snap.val()?'Online':'Offline'; });

      const typingRef = ref(db, `users/${recipientId}/typing/${conversationId}`);
      onValue(typingRef, snap => { typingIndicator.style.display = snap.val()?'block':'none'; });
    } else {
      recipientUser = { uid: recipientId };
    }

    const messagesRef = ref(db, `conversations/${conversationId}/messages`);
    onValue(messagesRef, snapshot => {
      messagesContainer.innerHTML = '';
      if(!snapshot.exists()) messagesContainer.innerHTML = '<div class="message-date">Start a conversation</div>';
      else snapshot.forEach(child => showMessage({id:child.key, ...child.val()}));
    });

    await markMessagesAsRead(conversationId, currentUser.uid);
  });

  sendBtn.addEventListener('click', sendMessage);
</script>

</body>
</html>